"use strict";$(function(){function e(e){var t=e.point.x,o=e.point.y,n={x:t+k.width-y.width,y:o+k.height-y.height};return n.x=n.x<0?0:n.x+10,n.y=n.y<0?0:n.y+10,t-=n.x,o-=n.y,n.x+n.y>0&&v.panBy([n.x,n.y],{duration:100},{type:null,point:null,target:null,reason:"fit",lngLat:null,originalEvent:null}),{top:o+15,left:t}}function t(e,t,o){e?(b.keyNav=function(e){switch(e.keyCode){case 27:b.mapInteraction();break;case 37:o();break;case 39:t()}},document.addEventListener("keydown",b.keyNav)):document.removeEventListener("keydown",b.keyNav)}function o(e,t){var o=v.getZoom(),i=3*o/Math.pow(2,o),r=[e.lng-i,e.lat-i],a=[e.lng+i,e.lat+i],c=x.features.filter(function(e){var t=e.geometry.coordinates;return t[0]>=r[0]&&t[1]>=r[1]&&t[0]<=a[0]&&t[1]<=a[1]}).map(function(t){return t.properties.distance=n(e,t.geometry.coordinates),t});return c.sort(function(e,t){return e.properties.distance-t.properties.distance}),c.slice(0,t)}function n(e,t){var o=e.lng,n=e.lat,i=t[0],r=t[1];return Math.sqrt(Math.pow(i-o,2)+Math.pow(r-n,2))}function i(){var e=v.getCenter(),t="/map?lat="+e.lat+"&lon="+e.lng+"&zoom="+v.getZoom();window.history.replaceState(null,null,t)}function r(){v.getZoom()>s.zoom&&!C?(C=!0,h.click(function(){v.easeTo(s),ga("send","event",d,"Zoom Out")}).removeClass("disabled")):v.getZoom()<=s.zoom&&C&&(C=!1,h.off("click").addClass("disabled"))}function a(e){return void 0===e&&(e=""),function(){m.style.cursor=e}}function c(e){var t=e.split("/"),o=t[t.length-1].split("_");window.location.href="/"+o[0]}function l(){v.addSource("photos",{type:"geojson",data:x,cluster:!0,clusterMaxZoom:18,clusterRadius:30}),v.addLayer({id:"cluster",type:"circle",source:"photos",filter:["has","point_count"],paint:{"circle-color":"#422","circle-radius":{property:"point_count",type:"interval",stops:[[0,10],[10,12],[100,15]]},"circle-opacity":w,"circle-stroke-width":3,"circle-stroke-color":"#ccc"}}),v.addLayer({id:"cluster-count",type:"symbol",source:"photos",filter:["has","point_count"],layout:{"text-field":"{point_count_abbreviated}","text-font":["Open Sans Bold","Arial Unicode MS Bold"],"text-size":14},paint:{"text-color":"#fff"}}),v.addLayer({id:"photo",type:"circle",source:"photos",filter:["!has","point_count"],paint:{"circle-color":"#f00","circle-radius":7,"circle-stroke-width":4,"circle-stroke-color":"#fdd","circle-opacity":w}}),v.on("mouseenter","cluster",a("pointer")).on("mouseleave","cluster",a()).on("mouseenter","photo",a("pointer")).on("mouseleave","photo",a()).on("zoomend",b.zoomEnd).on("moveend",i).on("click","cluster",b.clusterClick).on("click","photo",b.photoClick)}var s={zoom:6.5,center:[-116.0987,44.7]},d="Map",p=$("#photo-count"),u=$("#photo-preview"),h=$("#zoom-out"),f=function(){for(var e=window.location.search.split(/[&\?]/g),t={},o=0;o<e.length;o++){var n=e[o].split("=");2==n.length&&(t[n[0]]=parseFloat(n[1]))}return t.hasOwnProperty("lat")&&t.hasOwnProperty("lon")&&(t.center=[t.lon,t.lat]),t}(),g=new mapboxgl.NavigationControl,v=new mapboxgl.Map({container:"map-canvas",style:"mapbox://styles/"+mapStyle,center:f.center||s.center,zoom:f.zoom||s.zoom,maxZoom:18,dragRotate:!1,keyboard:!1}),m=v.getCanvasContainer(),w=.6,y={width:0,height:0},k={width:322,height:350},C=!1,x=null,z={icon:function(e,t){var o=$("<i>").addClass("material-icons "+e).text(e);return void 0!==t&&o.click(t),o},coordinate:function(e){var t=Math.pow(10,5),o=function(e){return Math.round(e*t)/t};return o(e[1])+", "+o(e[0])},photo:function(e){var t=e.properties,o="Click or tap to enlarge";return $("<figure>").append($("<img>").attr("src",t.url).attr("title",o).attr("alt",o).click(function(){c(t.url)})).append($("<figcaption>").html(this.coordinate(e.geometry.coordinates)))},photoPreview:function(t,o,n,i){u.empty().removeClass().css(e(t)),void 0!==i&&u.append(i),u.addClass(o).append(n).append(z.icon("close",b.closePreview)).show({complete:b.previewShown})}},b={zoomEnd:function(){i(),r()},keyNav:null,mapInteraction:function(e){void 0!==e&&"fit"!=e.reason&&b.closePreview()},windowResize:function(){var e=$("canvas");y.width=e.width(),y.height=e.height()},photoClick:function(e){z.photoPreview(e,"single",z.photo(e.features[0])),ga("send","event",d,"Click Photo Pin")},previewShown:function(){v.on("move",b.mapInteraction)},closePreview:function(){u.hide(),t(!1),v.off("move",b.mapInteraction)},legendToggle:function(){$(this).parents("ul").toggleClass("collapsed"),ga("send","event",d,"Toggle Legend")},clusterClick:function(e){var n=e.features[0].properties,i=v.getZoom(),r=function(){v.easeTo({center:e.lngLat,zoom:18-i<2?18:i+2})};if(n.point_count>20&&i<16)r();else{var a=o(e.lngLat,n.point_count);if(0==a.length)r();else{var c=1,l=$("<div>").addClass("photo-list"),s=$("<div>").addClass("markers"),p=function(e){c+=e,c>a.length?c=1:c<1&&(c=a.length),$("figure",l).hide(),$("i",s).removeClass("selected"),$("figure:nth-child("+c+")",l).show(),$("i:nth-child("+c+")",s).addClass("selected")},u=function(){p(-1)},h=function(){p(1)};t(!0,h,u);for(var f=0;f<a.length;f++)l.append(z.photo(a[f])),s.append(z.icon("place"));$("i:first-child",s).addClass("selected"),z.photoPreview(e,"list",l,$("<nav>").append(z.icon("arrow_back",u)).append(s).append(z.icon("arrow_forward",h)))}}ga("send","event",d,"Click Cluster")}};f.center&&r(),$("#legend .toggle i").click(b.legendToggle),window.addEventListener("resize",b.windowResize),v.addControl(g,"top-right").on("load",function(){$.getJSON("/geo.json",function(e){x=e,p.html(x.features.length+" photos").show(),l(),b.windowResize()})})});
//# sourceMappingURL=/js/maps/mapbox.js.map
