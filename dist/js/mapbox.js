"use strict";$(function(){function o(o){var e=o.point.x,t=o.point.y,n={x:e+M.width-z.width,y:t+M.height-z.height};return n.x=n.x<0?0:n.x+10,n.y=n.y<0?0:n.y+10,e-=n.x,t-=n.y,n.x+n.y>0&&k.panBy([n.x,n.y],{duration:100},{reason:"fit"}),{top:t+15,left:e}}function e(o,e,t){o?(P.keyNav=function(o){switch((window.event?window.event:o).keyCode){case 27:P.mapInteraction(o);break;case 37:t();break;case 39:e()}},document.addEventListener("keydown",P.keyNav)):document.removeEventListener("keydown",P.keyNav)}function t(o,e){var t=k.getZoom(),i=3*t/Math.pow(2,t),r=[o.lng-i,o.lat-i],a=[o.lng+i,o.lat+i],c=_.features.filter(function(o){var e=o.geometry.coordinates;return e[0]>=r[0]&&e[1]>=r[1]&&e[0]<=a[0]&&e[1]<=a[1]}).map(function(e){return e.properties.distance=n(o,e.geometry.coordinates),e});return c.sort(function(o,e){return o.properties.distance-e.properties.distance}),c.slice(0,e)}function n(o,e){var t=o.lng,n=o.lat,i=e[0],r=e[1];return Math.sqrt(Math.pow(i-t,2)+Math.pow(r-n,2))}function i(){var o=k.getCenter(),e="/map?lat="+o.lat+"&lon="+o.lng+"&zoom="+k.getZoom();window.history.replaceState(null,null,e)}function r(o){o!=p&&(p=o,p?(w.on.show(),w.off.hide()):(w.on.hide(),w.off.show()),k.once("data",function(o){"style"==o.dataType&&l()}),k.setStyle("mapbox://styles/"+(p?u.imagery:u.basic)))}function a(){k.getZoom()>d.zoom&&!b?(b=!0,m.click(function(){k.easeTo(d)}).removeClass("disabled")):k.getZoom()<=d.zoom&&b&&(b=!1,m.off("click").addClass("disabled"))}function c(o){return void 0===o&&(o=""),function(){C.style.cursor=o}}function s(o){var e=o.split("/"),t=e[e.length-1].split("_");window.location="/"+t[0]}function l(){k.addSource("photos",{type:"geojson",data:_,cluster:!0,clusterMaxZoom:18,clusterRadius:30}),k.addLayer({id:"cluster",type:"circle",source:"photos",filter:["has","point_count"],paint:{"circle-color":"#422","circle-radius":{property:"point_count",type:"interval",stops:[[0,10],[10,12],[100,15]]},"circle-opacity":x,"circle-stroke-width":3,"circle-stroke-color":"#ccc"}}),k.addLayer({id:"cluster-count",type:"symbol",source:"photos",filter:["has","point_count"],layout:{"text-field":"{point_count_abbreviated}","text-font":["Open Sans Bold","Arial Unicode MS Bold"],"text-size":14},paint:{"text-color":"#fff"}}),k.addLayer({id:"photo",type:"circle",source:"photos",filter:["!has","point_count"],paint:{"circle-color":"#f00","circle-radius":7,"circle-stroke-width":4,"circle-stroke-color":"#fdd","circle-opacity":x}}),k.on("mouseenter","cluster",c("pointer")).on("mouseleave","cluster",c()).on("mouseenter","photo",c("pointer")).on("mouseleave","photo",c()).on("zoomend",P.zoomEnd).on("moveend",i).on("click","cluster",P.clusterClick).on("click","photo",P.photoClick)}var p=!1,d={zoom:6.5,center:[-116.0987,44.7]},u={basic:"jabbott7/cj1qniq9r00322sqxt3pastcf",outdoors:"mapbox/outdoors-v10"},h=$("#photo-count"),f=$("#photo-preview"),v=$("#toggle-satellite"),m=$("#zoom-out"),w={on:$("nav .glyphicon-check"),off:$("nav .glyphicon-unchecked")},g=function(){for(var o=window.location.search.split(/[&\?]/g),e={},t=0;t<o.length;t++){var n=o[t].split("=");2==n.length&&(e[n[0]]=parseFloat(n[1]))}return e.hasOwnProperty("lat")&&e.hasOwnProperty("lon")&&(e.center=[e.lon,e.lat]),e}(),y=new mapboxgl.NavigationControl,k=new mapboxgl.Map({container:"map-canvas",style:"mapbox://styles/"+u.basic,center:g.center||d.center,zoom:g.zoom||d.zoom,maxZoom:18,dragRotate:!1,keyboard:!1}),C=k.getCanvasContainer(),x=.6,b=!1,z={width:0,height:0},M={width:322,height:350},_=null,L={icon:function(o,e){var t=$("<span>").addClass("glyphicon glyphicon-"+o);return void 0!==e&&t.click(e),t},coordinate:function(o){var e=Math.pow(10,5),t=function(o){return Math.round(o*e)/e};return t(o[1])+", "+t(o[0])},photo:function(o){var e=o.properties,t="Click or tap to enlarge";return $("<figure>").append($("<img>").attr("src",e.url).attr("title",t).attr("alt",t).click(function(){s(e.url)})).append($("<figcaption>").html(this.coordinate(o.geometry.coordinates)))},photoPreview:function(e,t,n,i){f.empty().removeClass().css(o(e)),void 0!==i&&f.append(i),f.addClass(t).append(n).append(L.icon("remove",P.closePreview)).show({complete:P.previewShown})}},P={zoomEnd:function(){i(),a()},keyNav:null,mapInteraction:function(o){"fit"!=o.reason&&P.closePreview()},windowResize:function(){var o=$("canvas");z.width=o.width(),z.height=o.height()},photoClick:function(o){L.photoPreview(o,"single",L.photo(o.features[0]))},previewShown:function(){k.on("move",P.mapInteraction)},closePreview:function(){f.hide(),e(!1),k.off("move",P.mapInteraction)},clusterClick:function(o){var n=o.features[0].properties,i=k.getZoom(),r=function(){k.easeTo({center:o.lngLat,zoom:18-i<2?18:i+2})};if(n.point_count>20&&i<16)r();else{var a=t(o.lngLat,n.point_count);if(0==a.length)r();else{var c=1,s=$("<div>").addClass("photo-list"),l=$("<div>").addClass("markers"),p=function(o){c+=o,c>a.length?c=1:c<1&&(c=a.length),$("figure",s).hide(),$("span",l).removeClass("selected"),$("figure:nth-child("+c+")",s).show(),$("span:nth-child("+c+")",l).addClass("selected")},d=function(){p(-1)},u=function(){p(1)};e(!0,u,d);for(var h=0;h<a.length;h++)s.append(L.photo(a[h])),l.append(L.icon("map-marker"));$("span:first-child",l).addClass("selected"),L.photoPreview(o,"list",s,$("<nav>").append(L.icon("arrow-left",d)).append(l).append(L.icon("arrow-right",u)))}}}};g.center&&a(),window.addEventListener("resize",P.windowResize),k.addControl(y,"top-right").on("load",function(){v.click(function(){r(!p)}),$.getJSON("/geo.json",function(o){_=o,h.html(_.features.length+" photos").show(),l(),P.windowResize()})})});
//# sourceMappingURL=/js/maps/mapbox.js.map
