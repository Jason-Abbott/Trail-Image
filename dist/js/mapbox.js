"use strict";$(function(){function o(o,t,e){o?(M.keyNav=function(o){switch((window.event?window.event:o).keyCode){case 27:M.mapInteraction(o);break;case 37:e();break;case 39:t()}},document.addEventListener("keydown",M.keyNav)):document.removeEventListener("keydown",M.keyNav)}function t(o,t){var n=w.getZoom(),r=3*n/Math.pow(2,n),a=[o.lng-r,o.lat-r],i=[o.lng+r,o.lat+r],c=x.features.filter(function(o){var t=o.geometry.coordinates;return t[0]>=a[0]&&t[1]>=a[1]&&t[0]<=i[0]&&t[1]<=i[1]}).map(function(t){return t.properties.distance=e(o,t.geometry.coordinates),t});return c.sort(function(o,t){return o.properties.distance-t.properties.distance}),c.slice(0,t)}function e(o,t){var e=o.lng,n=o.lat,r=t[0],a=t[1];return Math.sqrt(Math.pow(r-e,2)+Math.pow(a-n,2))}function n(){var o=w.getCenter(),t="/map?lat="+o.lat+"&lon="+o.lng+"&zoom="+w.getZoom();window.history.replaceState(null,null,t)}function r(o){o!=l&&(l=o,l?(g.on.show(),g.off.hide()):(g.on.hide(),g.off.show()),w.once("data",function(o){"style"==o.dataType&&s()}),w.setStyle("mapbox://styles/"+(l?d.imagery:d.basic)))}function a(){w.getZoom()>p.zoom&&!b?(b=!0,m.click(function(){w.easeTo(p)}).removeClass("disabled")):w.getZoom()<=p.zoom&&b&&(b=!1,m.off("click").addClass("disabled"))}function i(o){return void 0===o&&(o=""),function(){k.style.cursor=o}}function c(o){var t=o.split("/"),e=t[t.length-1].split("_");window.location="/"+e[0]}function s(){w.addSource("photos",{type:"geojson",data:x,cluster:!0,clusterMaxZoom:18,clusterRadius:30}),w.addLayer({id:"cluster",type:"circle",source:"photos",filter:["has","point_count"],paint:{"circle-color":"#422","circle-radius":{property:"point_count",type:"interval",stops:[[0,10],[10,12],[100,15]]},"circle-opacity":C,"circle-stroke-width":3,"circle-stroke-color":"#ccc"}}),w.addLayer({id:"cluster-count",type:"symbol",source:"photos",filter:["has","point_count"],layout:{"text-field":"{point_count_abbreviated}","text-font":["Open Sans Bold","Arial Unicode MS Bold"],"text-size":14},paint:{"text-color":"#fff"}}),w.addLayer({id:"photo",type:"circle",source:"photos",filter:["!has","point_count"],paint:{"circle-color":"#f00","circle-radius":7,"circle-stroke-width":4,"circle-stroke-color":"#fdd","circle-opacity":C}}),w.on("mouseenter","cluster",i("pointer")).on("mouseleave","cluster",i()).on("mouseenter","photo",i("pointer")).on("mouseleave","photo",i()).on("move",M.mapInteraction).on("click",M.mapInteraction).on("zoomend",M.zoomEnd).on("moveend",n).on("mousedown","cluster",M.clusterClick).on("mousedown","photo",M.photoClick)}var l=!1,p={zoom:6.5,center:[-116.0987,44.7]},d={basic:"jabbott7/cj1qniq9r00322sqxt3pastcf",outdoors:"mapbox/outdoors-v10"},u=$("#photo-count"),f=$("#photo-preview"),h=$("#toggle-satellite"),m=$("#zoom-out"),g={on:$("nav .glyphicon-check"),off:$("nav .glyphicon-unchecked")},v=function(){for(var o=window.location.search.split(/[&\?]/g),t={},e=0;e<o.length;e++){var n=o[e].split("=");2==n.length&&(t[n[0]]=parseFloat(n[1]))}return t.hasOwnProperty("lat")&&t.hasOwnProperty("lon")&&(t.center=[t.lon,t.lat]),t}(),y=new mapboxgl.NavigationControl,w=new mapboxgl.Map({container:"map-canvas",style:"mapbox://styles/"+d.basic,center:v.center||p.center,zoom:v.zoom||p.zoom,maxZoom:18,dragRotate:!1,keyboard:!1}),k=w.getCanvasContainer(),C=.6,b=!1,x=null,z={icon:function(o,t){var e=$("<span>").addClass("glyphicon glyphicon-"+o);return void 0!==t&&e.click(t),e},coordinate:function(o){var t=Math.pow(10,5),e=function(o){return Math.round(o*t)/t};return e(o[1])+", "+e(o[0])},photo:function(o){var t=o.properties,e="Click or tap to enlarge";return $("<figure>").append($("<img>").attr("src",t.url).attr("title",e).attr("alt",e).click(function(){c(t.url)})).append($("<figcaption>").html(this.coordinate(o.geometry.coordinates)))}},M={zoomEnd:function(){n(),a()},keyNav:null,mapInteraction:function(){f.hide(),o(!1)},photoClick:function(o){f.empty().css({top:o.point.y+15,left:o.point.x}).append(z.photo(o.features[0])).show()},clusterClick:function(e){var n=e.features[0].properties,r=w.getZoom(),a=function(){w.easeTo({center:e.lngLat,zoom:18-r<2?18:r+2})};if(n.point_count>20&&r<16)a();else{var i=t(e.lngLat,n.point_count);if(0==i.length)a();else{var c=1,s=$("<div>").addClass("photo-list"),l=$("<div>").addClass("markers"),p=function(o){c+=o,c>i.length?c=1:c<1&&(c=i.length),$("figure",s).hide(),$("span",l).removeClass("selected"),$("figure:nth-child("+c+")",s).show(),$("span:nth-child("+c+")",l).addClass("selected")},d=function(){p(-1)},u=function(){p(1)};o(!0,u,d);for(var h=0;h<i.length;h++)s.append(z.photo(i[h])),l.append(z.icon("map-marker"));$("span:first-child",l).addClass("selected"),f.empty().css({top:e.point.y+15,left:e.point.x}).append($("<nav>").append(z.icon("arrow-left",d)).append(l).append(z.icon("arrow-right",u))).append(s).show()}}}};v.center&&a(),w.addControl(y,"top-right").on("load",function(){h.click(function(){r(!l)}),$.getJSON("/geo.json",function(o){x=o,u.html(x.features.length+" photos").show(),s(),w.resize()})})});
//# sourceMappingURL=/js/maps/mapbox.js.map
