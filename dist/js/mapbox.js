"use strict";$(function(){function e(e){var o=e.point.x,t=e.point.y,n={x:o+C.width-k.width,y:t+C.height-k.height};return n.x=n.x<0?0:n.x+10,n.y=n.y<0?0:n.y+10,o-=n.x,t-=n.y,n.x+n.y>0&&m.panBy([n.x,n.y],{duration:100},{type:null,point:null,target:null,reason:"fit",lngLat:null,originalEvent:null}),{top:t+15,left:o}}function o(e,o,t){e?(L.keyNav=function(e){switch(e.keyCode){case 27:L.mapInteraction();break;case 37:t();break;case 39:o()}},document.addEventListener("keydown",L.keyNav)):document.removeEventListener("keydown",L.keyNav)}function t(e,o){var t=m.getZoom(),i=3*t/Math.pow(2,t),r=[e.lng-i,e.lat-i],a=[e.lng+i,e.lat+i],l=z.features.filter(function(e){var o=e.geometry.coordinates;return o[0]>=r[0]&&o[1]>=r[1]&&o[0]<=a[0]&&o[1]<=a[1]}).map(function(o){return o.properties.distance=n(e,o.geometry.coordinates),o});return l.sort(function(e,o){return e.properties.distance-o.properties.distance}),l.slice(0,o)}function n(e,o){var t=e.lng,n=e.lat,i=o[0],r=o[1];return Math.sqrt(Math.pow(i-t,2)+Math.pow(r-n,2))}function i(){var e=m.getCenter(),o=f+"/map?lat="+e.lat+"&lon="+e.lng+"&zoom="+m.getZoom();window.history.replaceState(null,null,o)}function r(){m.getZoom()>s.zoom&&!x?(x=!0,h.click(function(){m.easeTo(s),util.log.event(d,"Zoom Out")}).removeClass("disabled")):m.getZoom()<=s.zoom&&x&&(x=!1,h.off("click").addClass("disabled"))}function a(e){var o=e.split("/"),t=o[o.length-1].split("_");window.location.href="/"+t[0]}function l(e){m.addSource("track",{type:"geojson",data:e}),m.addLayer({id:"track",type:"line",source:"track",layout:{"line-join":"round","line-cap":"butt"},paint:{"line-color":"#f22","line-width":5,"line-opacity":.7,"line-dasharray":[1,.8]}}),m.fitBounds([post.bounds.sw,post.bounds.ne]),e&&$("#gpx-download").show()}function c(){m.addSource("photos",{type:"geojson",data:z,cluster:!0,clusterMaxZoom:18,clusterRadius:30}),m.addLayer({id:"cluster",type:"circle",source:"photos",filter:["has","point_count"],paint:{"circle-color":"#422","circle-radius":{property:"point_count",type:"interval",stops:[[0,10],[10,12],[100,15]]},"circle-opacity":y,"circle-stroke-width":3,"circle-stroke-color":"#ccc"}}),m.addLayer({id:"cluster-count",type:"symbol",source:"photos",filter:["has","point_count"],layout:{"text-field":"{point_count_abbreviated}","text-font":["Open Sans Bold","Arial Unicode MS Bold"],"text-size":14},paint:{"text-color":"#fff"}}),m.addLayer({id:"photo",type:"circle",source:"photos",filter:["!has","point_count"],paint:{"circle-color":"#f00","circle-radius":7,"circle-stroke-width":4,"circle-stroke-color":"#fdd","circle-opacity":y}}),m.on("mouseenter","cluster",P("pointer")).on("mouseleave","cluster",P()).on("mouseenter","photo",P("pointer")).on("mouseleave","photo",P()).on("zoomend",L.zoomEnd).on("moveend",i).on("click","cluster",L.clusterClick).on("click","photo",L.photoClick)}var s={zoom:6.5,center:[-116.0987,44.7]},d="Map",p=$("#photo-count"),u=$("#photo-preview"),h=$("#zoom-out"),f=post?"/"+post.key:"",g=function(){for(var e=window.location.search.split(/[&\?]/g),o={},t=0;t<e.length;t++){var n=e[t].split("=");2==n.length&&(o[n[0]]=parseFloat(n[1]))}return o.hasOwnProperty("lat")&&o.hasOwnProperty("lon")&&(o.center=[o.lon,o.lat]),o}(),v=new mapboxgl.NavigationControl,m=new mapboxgl.Map({container:"map-canvas",style:"mapbox://styles/"+mapStyle,center:g.center||s.center,zoom:g.zoom||s.zoom,maxZoom:18,dragRotate:!1,keyboard:!1}),w=m.getCanvasContainer(),y=.6,k={width:0,height:0},C={width:322,height:350},x=!1,z=null,b={icon:function(e,o){var t=$("<i>").addClass("material-icons "+e).text(e);return void 0!==o&&t.click(o),t},coordinate:function(e){var o=Math.pow(10,5),t=function(e){return Math.round(e*o)/o};return t(e[1])+", "+t(e[0])},photo:function(e){var o=e.properties,t="Click or tap to enlarge";return $("<figure>").append($("<img>").attr("src",o.url).attr("title",t).attr("alt",t).click(function(){a(o.url)})).append($("<figcaption>").html(this.coordinate(e.geometry.coordinates)))},photoPreview:function(o,t,n,i){u.empty().removeClass().css(e(o)),void 0!==i&&u.append(i),u.addClass(t).append(n).append(b.icon("close",L.closePreview)).show({complete:L.previewShown})}},L={zoomEnd:function(){i(),r()},keyNav:null,mapInteraction:function(e){void 0!==e&&"fit"!=e.reason&&L.closePreview()},windowResize:function(){var e=$("canvas");k.width=e.width(),k.height=e.height()},photoClick:function(e){b.photoPreview(e,"single",b.photo(e.features[0])),util.log.event(d,"Click Photo Pin")},previewShown:function(){m.on("move",L.mapInteraction)},closePreview:function(){u.hide(),o(!1),m.off("move",L.mapInteraction)},legendToggle:function(){$(this).parents("ul").toggleClass("collapsed"),util.log.event(d,"Toggle Legend")},clusterClick:function(e){var n=e.features[0].properties,i=m.getZoom(),r=function(){m.easeTo({center:e.lngLat,zoom:18-i<2?18:i+2})};if(n.point_count>20&&i<16)r();else{var a=t(e.lngLat,n.point_count);if(0==a.length)r();else{var l=1,c=$("<div>").addClass("photo-list"),s=$("<div>").addClass("markers"),p=function(e){l+=e,l>a.length?l=1:l<1&&(l=a.length),$("figure",c).hide(),$("i",s).removeClass("selected"),$("figure:nth-child("+l+")",c).show(),$("i:nth-child("+l+")",s).addClass("selected"),util.log.event(d,"Navigate Photo Cluster")},u=function(){p(-1)},h=function(){p(1)};o(!0,h,u);for(var f=0;f<a.length;f++)c.append(b.photo(a[f])),s.append(b.icon("place"));$("i:first-child",s).addClass("selected"),b.photoPreview(e,"list",c,$("<nav>").append(b.icon("arrow_back",u)).append(s).append(b.icon("arrow_forward",h)))}}util.log.event(d,"Click Cluster")}};g.center&&r(),$("#legend .toggle i").click(L.legendToggle),window.addEventListener("resize",L.windowResize),m.addControl(v,"top-right").on("load",function(){$.getJSON("/geo.json",function(e){z=e,p.html(z.features.length+" photos").show(),c(),L.windowResize()}),post.key&&$.getJSON("/"+post.key+"/geo.json",l)});var P=function(e){return void 0===e&&(e=""),function(){w.style.cursor=e}}});
//# sourceMappingURL=/js/maps/mapbox.js.map
