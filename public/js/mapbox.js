"use strict";$(function(){function g(t){return void 0===t&&(t=1024),window.innerWidth<=t}var t={zoom:6.5,center:[-116.0987,44.7]},o={font:["Open Sans Bold","Arial Unicode MS Bold"],minZoom:6,maxZoom:18},m="Map",e=$("#photo-count"),i=$("#photo-preview"),n=$("nav .zoom-out"),a=$("#legend .toggle"),l=post?"/"+post.key:"",r=function(){for(var t=window.location.search.split(/[&\?]/g),o={},e=0;e<t.length;e++){var n=t[e].split("=");2==n.length&&(o[n[0]]=parseFloat(n[1]))}void 0!==o.lon&&void 0!==o.lat&&(o.center=[o.lon,o.lat]);return o}(),c=new mapboxgl.NavigationControl,h=new mapboxgl.Map({container:"map-canvas",style:"mapbox://styles/"+mapStyle,center:r.center||t.center,zoom:r.zoom||t.zoom,maxZoom:18,dragRotate:!1,keyboard:!1}),s=h.getCanvasContainer(),u={width:0,height:0},d=322,p=350,v=!1,f=!g(),w=!0,y=!1,k=!1,b=null,C={coordinate:function(t){function o(t){return Math.round(t*e)/e}var e=Math.pow(10,5);return o(t[1])+", "+o(t[0])},photo:function(t){var o=t.properties;if(void 0===o.url)return null;var e="Click or tap to enlarge";return $("<figure>").append($("<img>").attr("src",o.url).attr("title",e).attr("alt",e).click(function(){!function(t){var o=t.split("/"),e=o[o.length-1].split("_");window.location.href="/"+e[0]}(o.url)})).append($("<figcaption>").html(this.coordinate(t.geometry.coordinates)))},photoPreview:function(t,o,e,n){i.empty().removeClass().css(function(t){var o=t.point.x,e=t.point.y;{if(g(767))return{top:(u.height-p)/2,right:0};var n={x:o+d-u.width,y:e+p-u.height};return n.x=n.x<0?0:n.x+10,n.y=n.y<0?0:n.y+10,o-=n.x,e-=n.y,0<n.x+n.y&&h.panBy([n.x,n.y],{duration:100},{lngLat:t.lngLat,type:"",point:t.point,originalEvent:t.originalEvent,reason:"fit",target:t.target}),{top:e+15,left:o+50}}}(t)),void 0!==n&&i.append(n),i.addClass(o).append(e).append(util.html.icon("close",x.closePreview)).show({complete:x.previewShown})}},x={zoomEnd:function(){L(),S()},keyNav:null,mapInteraction:function(t){void 0!==t&&"fit"!=t.reason&&x.closePreview()},windowResize:function(){var t=$("canvas");u.width=t.width(),u.height=t.height()},copyUrl:function(t){var o=$("<textarea>").text(window.location.href).appendTo(document.body).hide(),e=document.createRange();try{e.selectNode(o[0]);var n=window.getSelection();null!==n&&(n.removeAllRanges(),n.addRange(e)),util.log.event(m,"Copy URL")}catch(t){console.error(t)}o.remove()},buttonClick:function(t){window.location.href=$(this).data("link")},mapLink:function(t){var o=h.getCenter(),e=h.getZoom(),n=1/Math.pow(2.3,e)*375e6;window.location.href=$(this).data("link").replace("{lat}",o.lat).replace("{lon}",o.lng).replace("{zoom}",e).replace("{altitude}",n)},photoClick:function(t){var o=C.photo(t.features[0]);null!==o&&C.photoPreview(t,"single",o),util.log.event(m,"Click Photo Pin")},previewShown:function(){h.on("move",x.mapInteraction)},closePreview:function(){i.hide(),z(!1),h.off("move",x.mapInteraction)},photoLayerToggle:function(t){var o=(w=!w)?"visible":"none";["cluster","cluster-count","photo"].forEach(function(t){h.setLayoutProperty(t,"visibility",o)}),$(this).find("p").html((w?"Hide":"Show")+" Photos"),util.log.event(m,(w?"Show":"Hide")+" Photos")},legendToggle:function(){a.parents("ul").toggleClass("collapsed"),$("nav .toggle-legend").toggleClass("active"),f=!f,g()||(util.setting.showMapLegend=f),util.log.event(m,"Toggle Legend")},clusterClick:function(t){function o(){h.easeTo({center:t.lngLat,zoom:18-n<2?18:n+2})}var e=t.features[0].properties,n=h.getZoom();if(void 0!==e.point_count&&20<e.point_count&&n<16)o();else{var i=void 0===e.point_count?[]:function(o,t){var e=h.getZoom(),n=3*e/Math.pow(2,e),i=[o.lng-n,o.lat-n],a=[o.lng+n,o.lat+n],l=null===b?[]:b.features.filter(function(t){var o=t.geometry.coordinates;return o[0]>=i[0]&&o[1]>=i[1]&&o[0]<=a[0]&&o[1]<=a[1]}).map(function(t){return t.properties.distance=function(t,o){var e=t.lng,n=t.lat,i=o[0],a=o[1];return Math.sqrt(Math.pow(i-e,2)+Math.pow(a-n,2))}(o,t.geometry.coordinates),t});return l.sort(function(t,o){var e=t.properties.distance,n=o.properties.distance;return void 0===e&&(e=0),void 0===n&&(n=0),e-n}),l.slice(0,t)}(t.lngLat,e.point_count);if(0==i.length)o();else{var a=1,l=$("<div>").addClass("photo-list"),r=$("<div>").addClass("markers"),c=function(t){(a+=t)>i.length?a=1:a<1&&(a=i.length),$("figure",l).hide(),$("i",r).removeClass("selected"),$("figure:nth-child("+a+")",l).show(),$("i:nth-child("+a+")",r).addClass("selected"),y||(util.log.event(m,"Navigate Photo Cluster"),y=!0)},s=function(){c(-1)},u=function(){c(1)};g()||z(!0,u,s);for(var d=0;d<i.length;d++){var p=C.photo(i[d]);null!==p&&l.append(p)}if(20<i.length){r.addClass("too-many");for(d=0;d<i.length;d++)r.append($("<i>").html((d+1).toString()));r.append("of "+i.length)}else for(d=0;d<i.length;d++)r.append(util.html.icon("place"));$("i:first-child",r).addClass("selected"),C.photoPreview(t,"list",l,$("<nav>").append(util.html.icon("arrow_back",s)).append(r).append($("<div>").addClass("mobile-tip").html("tap photo to view post")).append(util.html.icon("arrow_forward",u)))}}util.log.event(m,"Click Cluster")}};function z(t,o,e){t?(x.keyNav=function(t){switch(t.keyCode){case 27:x.mapInteraction();break;case 37:void 0!==e&&e();break;case 39:void 0!==o&&o()}},document.addEventListener("keydown",x.keyNav)):null!==x.keyNav&&document.removeEventListener("keydown",x.keyNav)}function L(){if(k){var t=h.getCenter(),o=l+"/map?lat="+t.lat+"&lon="+t.lng+"&zoom="+h.getZoom();window.history.replaceState(null,"",o)}}function S(){void 0!==t.zoom&&(h.getZoom()>t.zoom&&!v?(v=!0,n.click(function(){h.easeTo(t),util.log.event(m,"Zoom Out")}).removeClass("disabled")):h.getZoom()<=t.zoom&&v&&(v=!1,n.off("click").addClass("disabled")))}r.center&&S(),a.click(x.legendToggle),$("nav button.toggle-legend").click(x.legendToggle),$("nav button.map-link").click(x.mapLink),$("nav button.copy-url").click(x.copyUrl),$("nav button.toggle-photos").click(x.photoLayerToggle),window.addEventListener("resize",x.windowResize),f?util.setting.showMapLegend||a.click():a.parents("ul").addClass("collapsed"),h.addControl(c,"top-right").on("load",function(){$.getJSON("/geo.json",function(t){null!==(b=t)?(e.find("div").html(b.features.length.toString()),function(){null!==b&&h.addSource("photos",{type:"geojson",data:b,cluster:!0,clusterMaxZoom:18,clusterRadius:30});h.addLayer({id:"cluster",type:"circle",source:"photos",filter:["has","point_count"],paint:{"circle-color":"#422","circle-radius":{property:"point_count",type:"interval",stops:[[0,10],[10,12],[100,15]]},"circle-opacity":.6,"circle-stroke-width":3,"circle-stroke-color":"#ccc"}}),h.addLayer({id:"cluster-count",type:"symbol",source:"photos",filter:["has","point_count"],layout:{"text-field":"{point_count_abbreviated}","text-font":o.font,"text-size":14},paint:{"text-color":"#fff"}}),h.addLayer({id:"photo",type:"circle",source:"photos",filter:["!has","point_count"],paint:{"circle-color":"#f00","circle-radius":7,"circle-stroke-width":4,"circle-stroke-color":"#fdd","circle-opacity":.6}})}(),h.on("mouseenter","cluster",M("pointer")).on("mouseleave","cluster",M()).on("mouseenter","photo",M("pointer")).on("mouseleave","photo",M()).on("zoomend",x.zoomEnd).on("moveend",L).on("click","cluster",x.clusterClick).on("click","photo",x.photoClick),h.addSource("moscow-mountain",{type:"vector",url:"mapbox://jabbott7.1q8zrllv"}),h.addLayer({id:"mountain-labels",type:"symbol",source:"moscow-mountain","source-layer":"moscow-mountain-dvde24",layout:{"text-font":o.font,"text-field":"{name}","text-size":{base:1,stops:[[10,10],[14,13]]},"text-rotation-alignment":"map","symbol-spacing":50},paint:{"text-color":"#fff","text-halo-color":"#000","text-halo-width":1,"text-halo-blur":1},minzoom:6,maxzoom:18}),h.addLayer({id:"mountain-tracks",type:"line",source:"moscow-mountain","source-layer":"moscow-mountain-dvde24",paint:{"line-color":"#55f","line-width":{base:1,stops:[[8,1],[13,2]]}},minzoom:o.minZoom,maxzoom:o.maxZoom},"mountain-labels"),x.windowResize(),post?(post.bounds.sw[0]-=.01,post.bounds.sw[1]-=.01,post.bounds.ne[0]+=.01,post.bounds.ne[1]+=.01,$.getJSON("/"+post.key+"/geo.json",Z)):k=!0):console.error("Unable to retrieve blog GeoJSON")})});var M=function(t){return void 0===t&&(t=""),function(){s.style.cursor=t}};function Z(t){0<t.features.length&&(h.addSource("track",{type:"geojson",data:t}).addLayer({id:"track",type:"line",source:"track",layout:{"line-join":"round","line-cap":"butt"},paint:{"line-color":"#f22","line-width":5,"line-opacity":.7,"line-dasharray":[1,.8]}},"photo"),$("#legend .track").removeClass("hidden")),$("nav > button.link").click(x.buttonClick),h.once("zoomend",function(){window.setTimeout(function(){k=!0},500)}),h.fitBounds([post.bounds.sw,post.bounds.ne])}});var util={setting:{save:function(t,o){window.localStorage&&localStorage.setItem(t,o)},load:function(t){return window.localStorage?localStorage.getItem(t):null},set showMapLegend(t){util.setting.save("map-legend",t?"true":"false")},get showMapLegend(){var t=util.setting.load("map-legend");return!t||"true"==t},set menuCategory(t){"string"==typeof t&&(t=[t,null]),null!==t&&util.setting.save("menu",t.join())},get menuCategory(){var t=util.setting.load("menu");return null===t?null:t[1].split(",")}},html:{icon:function(t,o){var e=$("<i>").addClass("material-icons "+t).text(t);return void 0!==o&&e.click(o),e}},log:{event:function(t,o,e){ga("send","event",t,o,e)}}};
//# sourceMappingURL=/js/maps/mapbox.js.map
