"use strict";$(function(){var t={zoom:6.5,center:[-116.0987,44.7]},e={font:["Open Sans Bold","Arial Unicode MS Bold"],minZoom:6,maxZoom:18},y="Map",o=$("#photo-count"),i=$("#photo-preview"),n=$("nav .zoom-out"),a=$("#legend .toggle"),l=post?"/"+post.key:"",r=function(){for(var t=window.location.search.split(/[&\?]/g),e={},o=0;o<t.length;o++){var n=t[o].split("=");2==n.length&&(e[n[0]]=parseFloat(n[1]))}e.hasOwnProperty("lat")&&e.hasOwnProperty("lon")&&(e.center=[e.lon,e.lat]);return e}(),c=new mapboxgl.NavigationControl,k=new mapboxgl.Map({container:"map-canvas",style:"mapbox://styles/"+mapStyle,center:r.center||t.center,zoom:r.zoom||t.zoom,maxZoom:18,dragRotate:!1,keyboard:!1}),s=k.getCanvasContainer(),d={width:0,height:0},u=322,p=350,b=function(t){return void 0===t&&(t=1024),window.innerWidth<=t},g=!1,h=!b(),m=!0,C=!1,f=!1,x=null,z={coordinate:function(t){var e=Math.pow(10,5),o=function(t){return Math.round(t*e)/e};return o(t[1])+", "+o(t[0])},photo:function(t){var n=t.properties,e="Click or tap to enlarge";return $("<figure>").append($("<img>").attr("src",n.url).attr("title",e).attr("alt",e).click(function(){var t,e,o;t=n.url,e=t.split("/"),o=e[e.length-1].split("_"),window.location.href="/"+o[0]})).append($("<figcaption>").html(this.coordinate(t.geometry.coordinates)))},photoPreview:function(t,e,o,n){i.empty().removeClass().css(function(t){var e=t.point.x,o=t.point.y;{if(b(767))return{top:(d.height-p)/2,right:0};var n={x:e+u-d.width,y:o+p-d.height};return n.x=n.x<0?0:n.x+10,n.y=n.y<0?0:n.y+10,e-=n.x,o-=n.y,0<n.x+n.y&&k.panBy([n.x,n.y],{duration:100},{type:null,point:null,target:null,reason:"fit",lngLat:null,originalEvent:null}),{top:o+15,left:e+50}}}(t)),void 0!==n&&i.append(n),i.addClass(e).append(o).append(util.html.icon("close",v.closePreview)).show({complete:v.previewShown})}},v={zoomEnd:function(){w(),S()},keyNav:null,mapInteraction:function(t){void 0!==t&&"fit"!=t.reason&&v.closePreview()},windowResize:function(){var t=$("canvas");d.width=t.width(),d.height=t.height()},copyUrl:function(t){var e=$("<textarea>").text(window.location.href).appendTo(document.body).hide(),o=document.createRange();try{o.selectNode(e[0]),window.getSelection().removeAllRanges(),window.getSelection().addRange(o),util.log.event(y,"Copy URL")}catch(t){console.error(t)}e.remove()},buttonClick:function(t){window.location.href=$(this).data("link")},mapLink:function(t){var e=k.getCenter(),o=k.getZoom(),n=1/Math.pow(2.3,o)*375e6;window.location.href=$(this).data("link").replace("{lat}",e.lat).replace("{lon}",e.lng).replace("{zoom}",o).replace("{altitude}",n)},photoClick:function(t){z.photoPreview(t,"single",z.photo(t.features[0])),util.log.event(y,"Click Photo Pin")},previewShown:function(){k.on("move",v.mapInteraction)},closePreview:function(){i.hide(),L(!1),k.off("move",v.mapInteraction)},photoLayerToggle:function(t){var e=(m=!m)?"visible":"none";["cluster","cluster-count","photo"].forEach(function(t){k.setLayoutProperty(t,"visibility",e)}),$(this).find("p").html((m?"Hide":"Show")+" Photos"),util.log.event(y,(m?"Show":"Hide")+" Photos")},legendToggle:function(){a.parents("ul").toggleClass("collapsed"),$("nav .toggle-legend").toggleClass("active"),h=!h,b()||(util.setting.showMapLegend=h),util.log.event(y,"Toggle Legend")},clusterClick:function(t){var r,e,o,n,i,a,l,c=t.features[0].properties,s=k.getZoom(),d=function(){k.easeTo({center:t.lngLat,zoom:18-s<2?18:s+2})};if(20<c.point_count&&s<16)d();else{var u=(r=t.lngLat,e=c.point_count,o=k.getZoom(),n=3*o/Math.pow(2,o),i=[r.lng-n,r.lat-n],a=[r.lng+n,r.lat+n],(l=x.features.filter(function(t){var e=t.geometry.coordinates;return e[0]>=i[0]&&e[1]>=i[1]&&e[0]<=a[0]&&e[1]<=a[1]}).map(function(t){var e,o,n,i,a,l;return t.properties.distance=(e=r,o=t.geometry.coordinates,n=e.lng,i=e.lat,a=o[0],l=o[1],Math.sqrt(Math.pow(a-n,2)+Math.pow(l-i,2))),t})).sort(function(t,e){return t.properties.distance-e.properties.distance}),l.slice(0,e));if(0==u.length)d();else{var p=1,g=$("<div>").addClass("photo-list"),h=$("<div>").addClass("markers"),m=function(t){(p+=t)>u.length?p=1:p<1&&(p=u.length),$("figure",g).hide(),$("i",h).removeClass("selected"),$("figure:nth-child("+p+")",g).show(),$("i:nth-child("+p+")",h).addClass("selected"),C||(util.log.event(y,"Navigate Photo Cluster"),C=!0)},f=function(){m(-1)},v=function(){m(1)};b()||L(!0,v,f);for(var w=0;w<u.length;w++)g.append(z.photo(u[w]));if(20<u.length){h.addClass("too-many");for(w=0;w<u.length;w++)h.append($("<i>").html((w+1).toString()));h.append("of "+u.length)}else for(w=0;w<u.length;w++)h.append(util.html.icon("place"));$("i:first-child",h).addClass("selected"),z.photoPreview(t,"list",g,$("<nav>").append(util.html.icon("arrow_back",f)).append(h).append($("<div>").addClass("mobile-tip").html("tap photo to view post")).append(util.html.icon("arrow_forward",v)))}}util.log.event(y,"Click Cluster")}};function L(t,e,o){t?(v.keyNav=function(t){switch(t.keyCode){case 27:v.mapInteraction();break;case 37:o();break;case 39:e()}},document.addEventListener("keydown",v.keyNav)):document.removeEventListener("keydown",v.keyNav)}function w(){if(f){var t=k.getCenter(),e=l+"/map?lat="+t.lat+"&lon="+t.lng+"&zoom="+k.getZoom();window.history.replaceState(null,null,e)}}function S(){k.getZoom()>t.zoom&&!g?(g=!0,n.click(function(){k.easeTo(t),util.log.event(y,"Zoom Out")}).removeClass("disabled")):k.getZoom()<=t.zoom&&g&&(g=!1,n.off("click").addClass("disabled"))}r.center&&S(),a.click(v.legendToggle),$("nav button.toggle-legend").click(v.legendToggle),$("nav button.map-link").click(v.mapLink),$("nav button.copy-url").click(v.copyUrl),$("nav button.toggle-photos").click(v.photoLayerToggle),window.addEventListener("resize",v.windowResize),h?util.setting.showMapLegend||a.click():a.parents("ul").addClass("collapsed"),k.addControl(c,"top-right").on("load",function(){$.getJSON("/geo.json",function(t){x=t,o.find("div").html(x.features.length.toString()),k.addSource("photos",{type:"geojson",data:x,cluster:!0,clusterMaxZoom:18,clusterRadius:30}),k.addLayer({id:"cluster",type:"circle",source:"photos",filter:["has","point_count"],paint:{"circle-color":"#422","circle-radius":{property:"point_count",type:"interval",stops:[[0,10],[10,12],[100,15]]},"circle-opacity":.6,"circle-stroke-width":3,"circle-stroke-color":"#ccc"}}),k.addLayer({id:"cluster-count",type:"symbol",source:"photos",filter:["has","point_count"],layout:{"text-field":"{point_count_abbreviated}","text-font":e.font,"text-size":14},paint:{"text-color":"#fff"}}),k.addLayer({id:"photo",type:"circle",source:"photos",filter:["!has","point_count"],paint:{"circle-color":"#f00","circle-radius":7,"circle-stroke-width":4,"circle-stroke-color":"#fdd","circle-opacity":.6}}),k.on("mouseenter","cluster",M("pointer")).on("mouseleave","cluster",M()).on("mouseenter","photo",M("pointer")).on("mouseleave","photo",M()).on("zoomend",v.zoomEnd).on("moveend",w).on("click","cluster",v.clusterClick).on("click","photo",v.photoClick),k.addSource("moscow-mountain",{type:"vector",url:"mapbox://jabbott7.1q8zrllv"}),k.addLayer({id:"mountain-labels",type:"symbol",source:"moscow-mountain","source-layer":"moscow-mountain-dvde24",layout:{"text-font":e.font,"text-field":"{name}","text-size":{base:1,stops:[[10,10],[14,13]]},"text-rotation-alignment":"map","symbol-spacing":50},paint:{"text-color":"#fff","text-halo-color":"#000","text-halo-width":1,"text-halo-blur":1},minzoom:6,maxzoom:18}),k.addLayer({id:"mountain-tracks",type:"line",source:"moscow-mountain","source-layer":"moscow-mountain-dvde24",paint:{"line-color":"#55f","line-width":{base:1,stops:[[8,1],[13,2]]}},minzoom:e.minZoom,maxzoom:e.maxZoom},"mountain-labels"),v.windowResize(),post?(post.bounds.sw[0]-=.01,post.bounds.sw[1]-=.01,post.bounds.ne[0]+=.01,post.bounds.ne[1]+=.01,$.getJSON("/"+post.key+"/geo.json",P)):f=!0})});var M=function(t){return void 0===t&&(t=""),function(){s.style.cursor=t}};function P(t){0<t.features.length&&(k.addSource("track",{type:"geojson",data:t}).addLayer({id:"track",type:"line",source:"track",layout:{"line-join":"round","line-cap":"butt"},paint:{"line-color":"#f22","line-width":5,"line-opacity":.7,"line-dasharray":[1,.8]}},"photo"),$("#legend .track").removeClass("hidden")),$("nav > button.link").click(v.buttonClick),k.once("zoomend",function(){window.setTimeout(function(){f=!0},500)}),k.fitBounds([post.bounds.sw,post.bounds.ne])}});var util={setting:{save:function(t,e){window.localStorage&&localStorage.setItem(t,e)},load:function(t){return window.localStorage?localStorage.getItem(t):null},set showMapLegend(t){util.setting.save("map-legend",t?"true":"false")},get showMapLegend(){var t=util.setting.load("map-legend");return!t||"true"==t},set menuCategory(t){"string"==typeof t&&(t=[t,null]),util.setting.save("menu",t.join())},get menuCategory(){var t=util.setting.load("menu");return null===t?null:t[1].split(",")}},html:{icon:function(t,e){var o=$("<i>").addClass("material-icons "+t).text(t);return void 0!==e&&o.click(e),o}},log:{event:function(t,e,o){ga("send","event",t,e,o)}}};
//# sourceMappingURL=/js/maps/mapbox.js.map
